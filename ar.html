<html>
	<head>
		<title>SmartArm Digital Twin</title>
		<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
		<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
		<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
		<script>
			var SERVO_MIDDLE_C8Y_ID = 69201;
			var SERVO_LEFT_C8Y_ID = 68638;
			var SERVO_RIGHT_C8Y_ID = 68641;
			var SERVO_CLAW_C8Y_ID = 69213;
		</script>
	</head>

	<body style='margin : 0px; overflow: hidden;'>
		<a-scene arjs="debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
			<a-assets>
				<img id="popup" src="img/popup.png"/>
			</a-assets>
			<a-marker preset="custom" type='pattern' url='markers/M-marker.patt'>
				<a-text value="Servo middle" position="1 2.6 0" align="center" anchor="center" width="20" color="#00BFFF"></a-text>
				<a-text font="exo2bold" id="middle_position" value="0 %" position="1 1.8 0" align="center" anchor="center" width="25" color="#00BFFF"></a-text>
				<a-image src="#popup"  width="1" height="1" position="0 3.5 -0.5"></a-image>
			</a-marker>
			<a-marker preset="custom" type='pattern' url='markers/L-marker.patt'>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" value="Servo left" position="0 2.6 0" align="center" anchor="center" width="20" color="#00BFFF"></a-text>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" font="exo2bold" id="left_position" value="0 %" position="0 1.8 0" align="center" anchor="center" width="25" color="#00BFFF"></a-text>
			</a-marker>
			<a-marker preset="custom" type='pattern' url='markers/R-marker.patt'>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" value="Servo right" position="0 2.6 0" align="center" anchor="center" width="20" color="#00BFFF"></a-text>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" font="exo2bold" id="right_position" value="0 %" position="0 1.8 0" align="center" anchor="center" width="25" color="#00BFFF"></a-text>
			</a-marker>
			<a-marker preset='custom' type='pattern' url='markers/C-marker.patt'>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" value="Servo claw" position="0 2.6 0" align="center" anchor="center" width="20" color="#00BFFF"></a-text>
				<a-text geometry="primitive: plane; width: 7; height: 2;" material="color: #eee" font="exo2bold" id="claw_position" value="0 %" position="0 1.8 0" align="center" anchor="center" width="25" color="#00BFFF"></a-text>
			</a-marker>
			<a-camera-static position rotation scale visible material camera>
				<!--<a-cursor></a-cursor>-->
			</a-camera-static>
			<a-entity light="type: ambient; color: #FFF; intensity: 5;"></a-entity>
		</a-scene>
		<script>
			var sentHandshake = false;
			var sentSubscription = false;
			var sentConnect = false;
			var clientId = '';

			var host = "wss://pefgfi.cumulocity.com/cep/realtime";
			try {
				socket = new WebSocket(host);

				socket.onopen = function (openEvent) {
					connectWS();
				};

				socket.onmessage = function (messageEvent) {
					if (messageEvent.data instanceof Blob) {
						//
					} else {
						var data = JSON.parse(messageEvent.data)[0];
						if(!sentSubscription && data.successful) {
							clientId = data.clientId;
							connectWS();
						} else if(!sentConnect && data.successful) {
							connectWS();
						} else {
							if(data.data.data.smartarm_servos) {
								var content = data.data.data.smartarm_servos;
								if(content.middle_angle) {
									document.querySelector('a-scene').querySelector('#middle_position')
										.setAttribute('value', content.middle_angle.value + ' %');
								}
								if(content.left_angle) {
									document.querySelector('a-scene').querySelector('#left_position')
										.setAttribute('value', content.left_angle.value + ' %');
								}
								if(content.right_angle) {
									document.querySelector('a-scene').querySelector('#right_position')
										.setAttribute('value', content.right_angle.value + ' %');
								}
								if(content.claw_angle) {
									document.querySelector('a-scene').querySelector('#claw_position')
										.setAttribute('value', content.claw_angle.value + ' %');
								}
							}
						}
					}
				 };

				socket.onerror = function (errorEvent) {
					alert('WebSocket Status:: Error was reported');
				};

				socket.onclose = function (closeEvent) {
					alert('WebSocket Status:: Socket Closed');
				};
			} catch (exception) { if (window.console) console.log(exception); }
			
			function sendTextMessage(text) {
				if (socket.readyState != WebSocket.OPEN) return;
				socket.send(text);
			}

			function connectWS() {
			 if(!sentHandshake) {
				 sendTextMessage(JSON.stringify([{"channel":"/meta/handshake","ext":{"com.cumulocity.authn":{"token":"dGVzdHNfcnVubmVyOnRlc3RzX3J1bm5lcg=="}}, "version":"1.0","mininumVersion":"1.0beta","supportedConnectionTypes":["websocket","long-polling","callback-polling"],"advice":{"timeout":120000,"interval":30000}}]));
				 sentHandshake=true;
			 } else if (!sentSubscription) {
				sendTextMessage(JSON.stringify([
				  {
					"channel": "/meta/subscribe",
					"clientId": clientId,
					"subscription": "/measurements/*"
				  }
				]));
				sentSubscription = true;
			 } else if (!sentConnect) {
				sendTextMessage(JSON.stringify([
				  {
					"channel": "/meta/connect",
					"clientId": clientId,
					"connectionType": "websocket",
					"advice":{"timeout":1200000,"interval":30000}
				  }
				]));
				sentConnect = true;
			 }
			}
			
			
			function getDate(daysOffset) {
				var monthNames = [
					"Jan", "Fev", "Mar",
					"Avr", "Mai", "Juin", "Juil",
					"Aout", "Sept", "Oct",
					"Nov", "Dec"
				  ];
				var date = new Date();
				var day = date.getDate() + daysOffset;
				var monthIndex = date.getMonth();
				var year = date.getFullYear();
				return day + ' ' + monthNames[monthIndex] + ' ' + year;
			}
			
			// === INIT MIDDLE ===
			(function(){
				// init data
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						var jsonresp = JSON.parse(xmlHttp.responseText);
						var measurement = jsonresp.measurements[0].smartarm_servos.middle_angle.value;
						document.querySelector('a-scene').querySelector('#middle_position').setAttribute('value', measurement + ' %');
					}
				}
				xmlHttp.open("GET", "https://pefgfi.cumulocity.com/measurement/measurements?source="+SERVO_MIDDLE_C8Y_ID+"&fromDate=2018-01-01&pageSize=1&dateTo=2020-01-01&revert=true", true); // true for asynchronous 
				xmlHttp.setRequestHeader("Authorization", "Basic " + btoa("demo:demodemo"));
				xmlHttp.send(null);
			})();
			
			// === INIT LEFT ===
			(function(){
				// init data
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						var jsonresp = JSON.parse(xmlHttp.responseText);
						var measurement = jsonresp.measurements[0].smartarm_servos.left_angle.value;
						document.querySelector('a-scene').querySelector('#left_position').setAttribute('value', measurement + ' %');
					}
				}
				xmlHttp.open("GET", "https://pefgfi.cumulocity.com/measurement/measurements?source="+SERVO_LEFT_C8Y_ID+"&fromDate=2018-01-01&pageSize=1&dateTo=2020-01-01&revert=true", true); // true for asynchronous 
				xmlHttp.setRequestHeader("Authorization", "Basic " + btoa("demo:demodemo"));
				xmlHttp.send(null);
			})();
			
			// === INIT RIGHT ===
			(function(){
				// init data
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						var jsonresp = JSON.parse(xmlHttp.responseText);
						var measurement = jsonresp.measurements[0].smartarm_servos.right_angle.value;
						document.querySelector('a-scene').querySelector('#right_position').setAttribute('value', measurement + ' %');
					}
				}
				xmlHttp.open("GET", "https://pefgfi.cumulocity.com/measurement/measurements?source="+SERVO_RIGHT_C8Y_ID+"&fromDate=2018-01-01&pageSize=1&dateTo=2020-01-01&revert=true", true); // true for asynchronous 
				xmlHttp.setRequestHeader("Authorization", "Basic " + btoa("demo:demodemo"));
				xmlHttp.send(null);
			})();
			
			// === INIT CLAW ===
			(function(){
				// init data
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
						var jsonresp = JSON.parse(xmlHttp.responseText);
						var measurement = jsonresp.measurements[0].smartarm_servos.claw_angle.value;
						document.querySelector('a-scene').querySelector('#claw_position').setAttribute('value', measurement + ' %');
					}
				}
				xmlHttp.open("GET", "https://pefgfi.cumulocity.com/measurement/measurements?source="+SERVO_CLAW_C8Y_ID+"&fromDate=2018-01-01&pageSize=1&dateTo=2020-01-01&revert=true", true); // true for asynchronous 
				xmlHttp.setRequestHeader("Authorization", "Basic " + btoa("demo:demodemo"));
				xmlHttp.send(null);
			})();
			
		</script>
	</body>
</html>